# AGENTS.md

Руководство для агентных инструментов, работающих в `C:\Users\PCC\Desktop\steps_actu`.

## Область действия и приоритет

- Применяется ко всему репозиторию.
- Сначала выполнять явные инструкции пользователя, затем правила из этого файла.
- Делать точечные изменения без лишнего рефакторинга.

## Реальное устройство проекта

- Репозиторий скриптовый, на Python, без пакетной системы сборки.
- Основной рантайм: `live_trading_bot.py`.
- Ключевая торговая/ML-логика находится в `src/`.
- Файлы `test_*.py` в корне — это скрипты с `main()`, а не unit-тесты pytest.
- Обычно используется виртуальное окружение `btc_trading_env`.

## Правила Cursor/Copilot

- Проверены пути `.cursorrules`, `.cursor/rules/`, `.github/copilot-instructions.md`.
- На момент анализа такие файлы не найдены.
- Если появятся, считать их обязательными и обновить этот документ.

## Подготовка окружения

Запускать из корня репозитория:

```bash
python -m venv btc_trading_env
btc_trading_env\Scripts\activate
pip install -r requirements.txt
```

## Команды build / lint / test

Формального build-пайплайна нет (`pyproject.toml`, `setup.py`, `Makefile`, CI-конфиг в корне отсутствуют).

### Эквивалент сборки

```bash
python -m compileall src
python -m compileall .
```

### Линт и форматирование

Конфигов линтера в репозитории нет. Для безопасной проверки использовать:

```bash
python -m py_compile src\*.py
python -m py_compile *.py
```

Если локально добавлены Ruff/Black/Mypy, не делать массовый рефакторинг без запроса пользователя.

### Тесты

Запуск одного тестового скрипта (предпочтительный single-test сценарий):

```bash
python test_realtime_720d.py
```

Запуск конкретного тест-скрипта:

```bash
python test_short_only.py
```

Запуск всех root-скриптов `test_*.py` (PowerShell):

```powershell
Get-ChildItem test_*.py | ForEach-Object { python $_.FullName }
```

Примечание по single test:

- Сейчас нет pytest-целей вида `::test_name`.
- Если pytest-тесты появятся, использовать `python -m pytest path/to/file.py::test_name`.

## Соглашения по стилю кода

Сначала ориентироваться на стиль текущего файла и соседнего кода.

### Импорты

- Порядок: стандартная библиотека, сторонние зависимости, локальные модули.
- Предпочитать явные импорты, не использовать `import *`.
- Минимизировать изменения импортов в нетронутых участках.
- Не добавлять новые `sys.path.insert(...)`, если можно обойтись без них.

### Форматирование

- Сохранять текущий стиль форматирования в конкретном файле.
- Не делать форматирование ради форматирования.
- Комментарии писать только там, где логика неочевидна (особенно торговая/математическая).

### Типизация

- Для новых и изменяемых функций по возможности добавлять аннотации типов.
- Продолжать текущий подход с `dataclass` и `typing`.
- В сигнатурах предпочитать конкретные типы (`pd.DataFrame`, `pd.Series`, `Dict[str, Any]`).
- Не запускать тотальную миграцию на строгую типизацию без запроса.

### Именование

- `snake_case` для функций и переменных.
- `PascalCase` для классов.
- `UPPER_SNAKE_CASE` для констант и конфигов.
- Использовать устойчивые доменные имена: `session`, `horizon`, `target`, `proba`, `thr_short`, `thr_long`.

### Безопасность данных и ML-логики

- Сортировать временной индекс перед `rolling`/`shift`.
- Не допускать look-ahead leakage, использовать лагированные признаки.
- Учитывать границы сессий при расчете таргетов и сигналов.
- Явно обрабатывать `NaN`/`inf` перед инференсом модели.

### Ошибки и логирование

- Для отсутствующих данных/моделей выбрасывать понятные исключения.
- Сетевые и биржевые вызовы оборачивать в `try/except`.
- Логировать полезный контекст: символ, время, пороги, причина выхода.
- Не допускать тихого падения логики.

### Секреты и учетные данные

- Не хардкодить реальные API-ключи и токены.
- Использовать переменные окружения.
- Не коммитить `.env` и дампы секретов.
- В `start_bot.bat` есть значения, похожие на ключи; считать их чувствительными и не тиражировать.

## Ожидания по проверкам

- Для изменения поведения запускать хотя бы один релевантный `test_*.py`.
- Для live-логики сначала проверять офлайн/бэктест скриптами.
- В отчете указывать команды и короткий результат.

## Управление изменениями

- Держать диффы компактными и локальными.
- Предпочитать доработку существующих модулей, а не дубли.
- Обновлять документацию при значимых изменениях поведения.
- При добавлении новых инструментов указывать команды в этом файле.

## Git-политика (подтверждена владельцем)

- Разрешены автономные коммиты без дополнительного подтверждения.
- Пуш выполнять напрямую в ветку `main`.
- Коммитить только значимые изменения: заметные правки логики и результата.
- Не коммитить мелкие косметические правки и микроправки без влияния на поведение.
- Предкоммитные проверки можно не запускать, если это не требуется текущей задачей.
- Соблюдать базовую безопасность: не коммитить секреты (`.env`, токены, ключи, дампы).
- Если в одном наборе есть значимые и мелкие изменения, по возможности коммитить только значимую часть.

## Чек-лист перед передачей

- `python -m compileall src` проходит.
- Запущен хотя бы один релевантный тестовый скрипт.
- Секреты не добавлены.
- Пути вывода согласованы с проектом (`data/`, `models/`, `results/`, `logs/`).
